<!doctype html>
<title>JSNES lite</title>
<canvas id=canvas width=256 height=240 style="background: #000"></canvas>
<br><b>Controls</b>: arrow keys + X + C + Start + Esc
<p><button id=dk onclick='play("roms/dk.nes")'>DK</button>
<button id=smb onclick='play("roms/smb.nes")'>SMB</button>
<button id=ic onclick='play("roms/ic.nes")'>IC</button>
<button onclick='play("roms/nestest.nes")'>nestest</button>
<button onclick='play("roms/ppu.nes")'>ppu</button>
<input type=file id=fileInput>
<style>
body { font: 14px Arial }
canvas { background: #000; height: calc(100vmin - 80px); width: calc((100vmin - 80px) * 1.067); image-rendering: crisp-edges; image-rendering: pixelated; }
#dk, #smb, #ic { display: none; }
.localhost #dk, .localhost #smb, .localhost #ic { display: inline; }
</style>
<script src="src/nes.js"></script>
<script src="src/rom.js"></script>
<script src="src/mappers.js"></script>
<script src="src/controller.js"></script>
<script src="src/cpu.js"></script>
<script src="src/papu.js"></script>
<script src="src/ppu.js"></script>
<script src="src/tile.js"></script>
<script>

// Debug mode
// ==========

// If hostname is localhost, show ROM shortcuts
document.body.className = location.host;

// Canvas + framebuffer
// ====================

var ctx = canvas.getContext("2d");
var imageData = ctx.getImageData(0,0,256,240);
var frameBuffer = new ArrayBuffer(imageData.data.length);
var frameBuffer8 = new Uint8ClampedArray(frameBuffer);
var frameBuffer32 = new Uint32Array(frameBuffer);

// AudioContext + audio buffers + samples lists
// =============================================

var audio = new AudioContext();
var audioprocessor = audio.createScriptProcessor(2048, 0, 2);
audioprocessor.connect(audio.destination);

// When the Audio processor requests new samples to play
audioprocessor.onaudioprocess = audioEvent => {

  // Ensure that we've buffered enough samples
  if(leftSamples.length > currentSample + 2048){
    for(var i = 0; i < 2048; i++){
    
      // Output (play) the buffers
      audioEvent.outputBuffer.getChannelData(0)[i] = leftSamples[currentSample];
      audioEvent.outputBuffer.getChannelData(1)[i] = rightSamples[currentSample];
      currentSample++;
    }
  }
}
var leftSamples = [];
var rightSamples = [];
var currentSample = 0;

// Load ROM + Start emulator
// =========================
var interval;
start = file => {

  // Initialize JSNES
  NES.init({
    
    // Display each new frame on the canvas
    onFrame: function(frameBuffer){
      var i = 0;
      for(var x = 0; x < 256; ++x){
        for(var y = 0; y < 240; ++y){
          i = y * 256 + x;
          frameBuffer32[i] = 0xff000000 | frameBuffer[i];
        }
      }
      imageData.data.set(frameBuffer8);
      ctx.putImageData(imageData, 0, 0);
    },
    
    // Add new audio samples to the Audio buffers
    onAudioSample: function(left, right){
      leftSamples.push(left);
      rightSamples.push(right);
    },
    
    // Pass the browser's sample rate to the emulator
    sampleRate: 44100,
  });

  // Reset emulator
  NES.reset();
  
  // Send ROM to emulator
  NES.load_rom(file);
  
  // First 10 frames are garbage
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();
  NES.frame();

  // 60 fps loop
  clearInterval(interval);
  interval = setInterval(NES.frame, 16);
  
  // Controller #1 keys listeners
  onkeydown = e => {
    if(e.keyCode == 37) NES.buttonDown(1, Controller.BUTTON_LEFT);
    else if(e.keyCode == 38) NES.buttonDown(1, Controller.BUTTON_UP);
    else if(e.keyCode == 39) NES.buttonDown(1, Controller.BUTTON_RIGHT);
    else if(e.keyCode == 40) NES.buttonDown(1, Controller.BUTTON_DOWN);
    else if(e.keyCode == 88) NES.buttonDown(1, Controller.BUTTON_A); // X
    else if(e.keyCode == 67) NES.buttonDown(1, Controller.BUTTON_B); // C
    else if(e.keyCode == 27) NES.buttonDown(1, Controller.BUTTON_SELECT);
    else if(e.keyCode == 13) NES.buttonDown(1, Controller.BUTTON_START);
  }

  onkeyup = e => {
    if(e.keyCode == 37) NES.buttonUp(1, Controller.BUTTON_LEFT);
    else if(e.keyCode == 38) NES.buttonUp(1, Controller.BUTTON_UP);
    else if(e.keyCode == 39) NES.buttonUp(1, Controller.BUTTON_RIGHT);
    else if(e.keyCode == 40) NES.buttonUp(1, Controller.BUTTON_DOWN);
    else if(e.keyCode == 88) NES.buttonUp(1, Controller.BUTTON_A); // X
    else if(e.keyCode == 67) NES.buttonUp(1, Controller.BUTTON_B); // C
    else if(e.keyCode == 27) NES.buttonUp(1, Controller.BUTTON_SELECT);
    else if(e.keyCode == 13) NES.buttonUp(1, Controller.BUTTON_START);
  }
};

// Load ROM from file input
fileInput.onchange = () => {
  var fileReader = new FileReader();
  fileReader.readAsBinaryString(fileInput.files[0]);
  fileReader.onload = () => {
    start(fileReader.result);
  }
}

// load ROM from disk
play = path => {
  file = new XMLHttpRequest;
  file.open('GET', path);
  file.overrideMimeType("text/plain; charset=x-user-defined");
  file.send();
  file.onload = function(){
    start(file.responseText);
  }
}
</script>